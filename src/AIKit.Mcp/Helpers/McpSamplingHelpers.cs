// Generated by Copilot
using Microsoft.Extensions.AI;
using ModelContextProtocol;
using ModelContextProtocol.Protocol;
using ModelContextProtocol.Server;
using System.Text.Json.Nodes;

namespace AIKit.Mcp;

/// <summary>
/// Provides simplified methods for handling sampling requests in MCP servers.
/// </summary>
public static class McpSamplingHelpers
{
    /// <summary>
    /// Creates a sampling handler that uses an IChatClient for LLM requests.
    /// </summary>
    /// <param name="chatClient">The chat client to use for sampling.</param>
    /// <returns>A sampling handler function.</returns>
    public static Func<CreateMessageRequestParams?, IProgress<ProgressNotificationValue>, CancellationToken, ValueTask<CreateMessageResult>> CreateSamplingHandler(
        IChatClient chatClient)
    {
        return chatClient.CreateSamplingHandler();
    }

    /// <summary>
    /// Performs a simple text generation request using the server's sampling capability.
    /// </summary>
    /// <param name="server">The MCP server instance.</param>
    /// <param name="prompt">The text prompt to send to the LLM.</param>
    /// <param name="maxTokens">Maximum number of tokens to generate.</param>
    /// <param name="temperature">Sampling temperature (0.0 to 1.0).</param>
    /// <param name="cancellationToken">The cancellation token.</param>
    /// <returns>The generated text content.</returns>
    public static async Task<string> GenerateTextAsync(
        McpServer server,
        string prompt,
        int maxTokens = 100,
        float? temperature = null,
        CancellationToken cancellationToken = default)
    {
        var result = await server.SampleAsync(new CreateMessageRequestParams
        {
            Messages = [new SamplingMessage
            {
                Role = Role.User,
                Content = [new TextContentBlock { Text = prompt }]
            }],
            MaxTokens = maxTokens,
            Temperature = temperature
        }, cancellationToken);

        return result.Content.OfType<TextContentBlock>().FirstOrDefault()?.Text ?? string.Empty;
    }

    /// <summary>
    /// Performs a chat-based sampling request using the server's sampling capability.
    /// </summary>
    /// <param name="server">The MCP server instance.</param>
    /// <param name="messages">The chat messages for the conversation.</param>
    /// <param name="maxTokens">Maximum number of tokens to generate.</param>
    /// <param name="temperature">Sampling temperature (0.0 to 1.0).</param>
    /// <param name="systemPrompt">Optional system prompt.</param>
    /// <param name="cancellationToken">The cancellation token.</param>
    /// <returns>The generated chat response.</returns>
    public static async Task<ChatResponse> GenerateChatResponseAsync(
        McpServer server,
        IEnumerable<ChatMessage> messages,
        int? maxTokens = null,
        float? temperature = null,
        string? systemPrompt = null,
        CancellationToken cancellationToken = default)
    {
        var chatOptions = new ChatOptions
        {
            MaxOutputTokens = maxTokens,
            Temperature = temperature,
            Instructions = systemPrompt
        };

        return await server.SampleAsync(messages, chatOptions, cancellationToken: cancellationToken);
    }

    /// <summary>
    /// Performs code generation using the server's sampling capability.
    /// </summary>
    /// <param name="server">The MCP server instance.</param>
    /// <param name="language">The programming language for the code.</param>
    /// <param name="description">Description of the code to generate.</param>
    /// <param name="maxTokens">Maximum number of tokens to generate.</param>
    /// <param name="temperature">Sampling temperature (0.0 to 1.0).</param>
    /// <param name="cancellationToken">The cancellation token.</param>
    /// <returns>The generated code.</returns>
    public static async Task<string> GenerateCodeAsync(
        McpServer server,
        string language,
        string description,
        int maxTokens = 200,
        float? temperature = null,
        CancellationToken cancellationToken = default)
    {
        var prompt = $"Generate {language} code for: {description}. Provide only the code without explanations.";

        return await GenerateTextAsync(server, prompt, maxTokens, temperature, cancellationToken);
    }

    /// <summary>
    /// Performs structured output generation using JSON schema.
    /// </summary>
    /// <param name="server">The MCP server instance.</param>
    /// <param name="prompt">The text prompt describing the structure.</param>
    /// <param name="jsonSchema">The JSON schema for the output.</param>
    /// <param name="maxTokens">Maximum number of tokens to generate.</param>
    /// <param name="temperature">Sampling temperature (0.0 to 1.0).</param>
    /// <param name="cancellationToken">The cancellation token.</param>
    /// <returns>The generated JSON as a JsonNode.</returns>
    public static async Task<JsonNode?> GenerateStructuredOutputAsync(
        McpServer server,
        string prompt,
        string jsonSchema,
        int maxTokens = 300,
        float? temperature = null,
        CancellationToken cancellationToken = default)
    {
        var fullPrompt = $"{prompt}\n\nRespond with valid JSON matching this schema:\n{jsonSchema}";

        var result = await GenerateTextAsync(server, fullPrompt, maxTokens, temperature, cancellationToken);

        try
        {
            return JsonNode.Parse(result);
        }
        catch
        {
            return null; // Invalid JSON
        }
    }

    /// <summary>
    /// Creates a task-based sampling request that can be polled for completion.
    /// </summary>
    /// <param name="server">The MCP server instance.</param>
    /// <param name="prompt">The text prompt to send to the LLM.</param>
    /// <param name="maxTokens">Maximum number of tokens to generate.</param>
    /// <param name="temperature">Sampling temperature (0.0 to 1.0).</param>
    /// <param name="taskMetadata">Metadata for the task including TTL.</param>
    /// <param name="cancellationToken">The cancellation token.</param>
    /// <returns>The MCP task that can be polled for results.</returns>
    public static async Task<McpTask> GenerateTextAsTaskAsync(
        McpServer server,
        string prompt,
        int maxTokens = 100,
        float? temperature = null,
        McpTaskMetadata? taskMetadata = null,
        CancellationToken cancellationToken = default)
    {
        taskMetadata ??= new McpTaskMetadata { TimeToLive = TimeSpan.FromMinutes(5) };

        return await server.SampleAsTaskAsync(new CreateMessageRequestParams
        {
            Messages = [new SamplingMessage
            {
                Role = Role.User,
                Content = [new TextContentBlock { Text = prompt }]
            }],
            MaxTokens = maxTokens,
            Temperature = temperature
        }, taskMetadata, cancellationToken);
    }
}